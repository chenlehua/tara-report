import{_ as z,r as g,c as A,a as i,o as r,b as I,w,n as E,d as e,t as y,e as b,F as J,f as R,g as F,h as N,i as ne,j as ie,k as re,l as D,v as S}from"./index-BYRN50ky.js";import{uploadImage as de}from"./index-fc_ROXrg.js";const ue={class:"image-uploader"},ce={class:"label"},ve={key:1,class:"preview-area"},pe=["src","alt"],fe={class:"overlay"},me={class:"label"},ge={key:2,class:"uploading-overlay"},ye={__name:"ImageUploader",props:{label:{type:String,required:!0},imageType:{type:String,required:!0},uploadedImage:{type:Object,default:null}},emits:["upload","remove"],setup(C,{emit:B}){const f=C,d=B,v=g(!1),c=g(!1),M=A(()=>{var p,a;return(p=f.uploadedImage)!=null&&p.file?URL.createObjectURL(f.uploadedImage.file):((a=f.uploadedImage)==null?void 0:a.url)||""});function m(p){v.value=!1;const a=p.dataTransfer.files;a.length>0&&a[0].type.startsWith("image/")&&h(a[0])}function T(p){const a=p.target.files;a.length>0&&h(a[0])}async function h(p){c.value=!0;try{d("upload",{file:p,imageType:f.imageType})}finally{c.value=!1}}function V(){d("remove",f.imageType)}return(p,a)=>(r(),i("div",ue,[C.uploadedImage?(r(),i("div",ve,[e("img",{src:M.value,alt:C.label},null,8,pe),e("div",fe,[e("span",me,y(C.label),1),e("button",{class:"btn-remove",onClick:V},[...a[5]||(a[5]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])])])])):(r(),i("div",{key:0,class:E(["upload-area",{dragover:v.value}]),onDrop:w(m,["prevent"]),onDragover:a[0]||(a[0]=w($=>v.value=!0,["prevent"])),onDragleave:a[1]||(a[1]=$=>v.value=!1),onClick:a[2]||(a[2]=$=>p.$refs.fileInput.click())},[e("input",{ref:"fileInput",type:"file",accept:"image/*",style:{display:"none"},onChange:T},null,544),a[3]||(a[3]=e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[e("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),e("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),e("path",{d:"M21 15l-5-5L5 21"})],-1)),e("span",ce,y(C.label),1),a[4]||(a[4]=e("span",{class:"hint"},"点击上传",-1))],34)),c.value?(r(),i("div",ge,[...a[6]||(a[6]=[e("svg",{class:"animate-spin",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[e("circle",{cx:"12",cy:"12",r:"10","stroke-opacity":"0.25"}),e("path",{d:"M12 2a10 10 0 0110 10","stroke-linecap":"round"})],-1),e("span",null,"上传中...",-1)])])):I("",!0)]))}},ke=z(ye,[["__scopeId","data-v-319e79a2"]]),he={class:"generator-page animate-fadeIn"},_e={class:"generator-content"},we={class:"upload-section"},xe={class:"card upload-card"},be={key:0},Ce={key:1,class:"file-selected"},Be={key:0,class:"file-item"},Me={class:"file-info"},Ie={class:"file-name"},Te={class:"file-size"},$e={class:"card upload-card"},Ue={class:"image-upload-grid"},De={class:"card upload-card"},Se={class:"attack-trees-upload"},Ae={class:"attack-tree-header"},Ve={class:"attack-tree-index"},Le=["onClick"],je={class:"attack-tree-content"},Oe={class:"attack-tree-image-upload"},Je=["onClick","onDrop"],Re=["onChange"],Fe={key:1,class:"preview-area small"},Ne=["src","alt"],ze={class:"overlay"},Ee=["onClick"],Ge={class:"attack-tree-info"},He={class:"form-group"},Pe=["onUpdate:modelValue"],We={class:"form-group"},qe=["onUpdate:modelValue"],Xe={class:"form-group"},Ke=["onUpdate:modelValue"],Qe={class:"form-group full-width"},Ye=["onUpdate:modelValue"],Ze={class:"generate-section"},et=["disabled"],tt={key:0,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},st={key:1,class:"animate-spin",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},lt={key:0,class:"success-stats"},at={class:"stat-item"},ot={class:"stat-value"},nt={class:"stat-item"},it={class:"stat-value"},rt={class:"stat-item"},dt={class:"stat-value"},ut={class:"success-actions"},ct=["href"],vt={class:"modal-header"},pt={class:"modal-body"},ft=["src","alt"],mt={__name:"GeneratorView",setup(C){const B=g(!1),f=g(!1),d=g(null),v=g({}),c=g(null),M=g(!1),m=g([]),T=g([]),h=g({show:!1,url:"",title:""}),V=[{type:"item_boundary",label:"项目边界图"},{type:"system_architecture",label:"系统架构图"},{type:"software_architecture",label:"软件架构图"},{type:"dataflow",label:"数据流图"}],p=A(()=>c.value?`/api/reports/${c.value.report_id}/download`:""),a=A(()=>{var t,o;if(!((o=(t=c.value)==null?void 0:t.preview_data)!=null&&o.images))return{};const s=c.value.preview_data.images;return Object.fromEntries(Object.entries(s).filter(([k,l])=>l))});A(()=>Object.keys(a.value).length>0);function $(s){return s<1024?s+" B":s<1024*1024?(s/1024).toFixed(1)+" KB":(s/(1024*1024)).toFixed(1)+" MB"}function G(s){B.value=!1;const t=s.dataTransfer.files;t.length>0&&t[0].name.endsWith(".json")&&(d.value=t[0])}function H(s){const t=s.target.files;t.length>0&&(d.value=t[0])}function P(){d.value=null}async function W({file:s,imageType:t}){try{const o=await de(s,t);o.success&&(v.value[t]={id:o.image_id,url:o.image_url,file:s})}catch(o){alert("图片上传失败: "+o.message)}}function q(s){delete v.value[s]}function X(){m.value.push({asset_id:"",asset_name:"",title:"",description:"",file:null})}function K(s){m.value.splice(s,1)}function L(s){const t=T.value[s];t&&t.click()}function Q(s,t){const o=s.target.files;o.length>0&&o[0].type.startsWith("image/")&&(m.value[t].file=o[0])}function Y(s,t){const o=s.dataTransfer.files;o.length>0&&o[0].type.startsWith("image/")&&(m.value[t].file=o[0])}function Z(s){return s?URL.createObjectURL(s):""}async function ee(){var s,t,o,k;if(d.value){f.value=!0;try{const l=await te(d.value);if(m.value.length>0){const x=m.value.filter(_=>_.file||_.asset_id||_.asset_name).map((_,O)=>({asset_id:_.asset_id||`AT${String(O+1).padStart(3,"0")}`,asset_name:_.asset_name||`攻击树 ${O+1}`,title:_.title||"",description:_.description||"",attack_tree_image:""}));l.attack_trees||(l.attack_trees={}),l.attack_trees.attack_trees=x}const u=new Blob([JSON.stringify(l,null,2)],{type:"application/json"}),n=new File([u],d.value.name,{type:"application/json"}),ae={item_boundary:(s=v.value.item_boundary)==null?void 0:s.file,system_architecture:(t=v.value.system_architecture)==null?void 0:t.file,software_architecture:(o=v.value.software_architecture)==null?void 0:o.file,dataflow:(k=v.value.dataflow)==null?void 0:k.file,attack_trees:m.value.filter(x=>x.file).map(x=>x.file)},{uploadAndGenerate:oe}=await re(async()=>{const{uploadAndGenerate:x}=await import("./index-fc_ROXrg.js");return{uploadAndGenerate:x}},[]),U=await oe(n,ae);U.success?(c.value={report_id:U.report_info.id,statistics:U.report_info.statistics,preview_data:{images:{}}},M.value=!0):alert("生成失败: "+U.message)}catch(l){alert("生成失败: "+l.message)}finally{f.value=!1}}}function te(s){return new Promise((t,o)=>{const k=new FileReader;k.onload=l=>{try{const u=JSON.parse(l.target.result);t(u)}catch(u){o(new Error("JSON解析失败: "+u.message))}},k.onerror=()=>o(new Error("文件读取失败")),k.readAsText(s)})}function j(){h.value={show:!1,url:"",title:""}}function se(){M.value=!1}function le(){M.value=!1,d.value=null,v.value={},m.value=[],c.value=null}return(s,t)=>{var k;const o=ie("router-link");return r(),i("div",he,[t[31]||(t[31]=e("div",{class:"page-header"},[e("h1",null,"一键生成TARA报告"),e("p",{class:"page-desc"},"上传JSON参数文件和相关图片，快速生成专业的威胁分析与风险评估报告")],-1)),e("div",_e,[e("div",we,[e("div",xe,[t[10]||(t[10]=e("h3",null,[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[e("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e("path",{d:"M14 2v6h6"})]),b(" 上传JSON数据文件 ")],-1)),e("div",{class:E(["upload-zone",{dragover:B.value}]),onDrop:w(G,["prevent"]),onDragover:t[0]||(t[0]=w(l=>B.value=!0,["prevent"])),onDragleave:t[1]||(t[1]=l=>B.value=!1),onClick:t[2]||(t[2]=l=>s.$refs.jsonInput.click())},[e("input",{ref:"jsonInput",type:"file",accept:".json",style:{display:"none"},onChange:H},null,544),t[6]||(t[6]=e("svg",{class:"upload-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[e("path",{d:"M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"}),e("polyline",{points:"17,8 12,3 7,8"}),e("line",{x1:"12",y1:"3",x2:"12",y2:"15"})],-1)),d.value?(r(),i("p",Ce,y(d.value.name),1)):(r(),i("p",be,"点击或拖拽上传JSON文件")),t[7]||(t[7]=e("span",{class:"upload-hint"},"支持 .json 格式",-1))],34),d.value?(r(),i("div",Be,[t[9]||(t[9]=e("div",{class:"file-icon json"},[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[e("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e("path",{d:"M14 2v6h6"})])],-1)),e("div",Me,[e("div",Ie,y(d.value.name),1),e("div",Te,y($(d.value.size)),1)]),e("button",{class:"btn-remove",onClick:P},[...t[8]||(t[8]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])])])):I("",!0)]),e("div",$e,[t[11]||(t[11]=e("h3",null,[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[e("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),e("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),e("path",{d:"M21 15l-5-5L5 21"})]),b(" 上传相关图片（可选） ")],-1)),e("div",Ue,[(r(),i(J,null,R(V,l=>N(ke,{key:l.type,label:l.label,"image-type":l.type,"uploaded-image":v.value[l.type],onUpload:W,onRemove:q},null,8,["label","image-type","uploaded-image"])),64))])]),e("div",De,[t[20]||(t[20]=F('<h3 data-v-df85f461><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-v-df85f461><path d="M12 3v18" data-v-df85f461></path><path d="M18 9l-6-6-6 6" data-v-df85f461></path><path d="M6 15h12" data-v-df85f461></path><circle cx="6" cy="18" r="2" data-v-df85f461></circle><circle cx="18" cy="18" r="2" data-v-df85f461></circle><circle cx="12" cy="12" r="2" data-v-df85f461></circle></svg> 上传攻击树图片（可选） </h3><p class="section-hint" data-v-df85f461>可以上传多张攻击树图片，并为每张图片添加描述。上传的图片将自动替换JSON中的attack_trees字段。</p>',2)),e("div",Se,[(r(!0),i(J,null,R(m.value,(l,u)=>(r(),i("div",{key:u,class:"attack-tree-item"},[e("div",Ae,[e("span",Ve,"攻击树 #"+y(u+1),1),e("button",{class:"btn-remove-tree",onClick:n=>K(u),title:"删除此攻击树"},[...t[12]||(t[12]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])],8,Le)]),e("div",je,[e("div",Oe,[l.file?(r(),i("div",Fe,[e("img",{src:Z(l.file),alt:`攻击树 ${u+1}`},null,8,Ne),e("div",ze,[e("button",{class:"btn-change",onClick:n=>L(u)},"更换",8,Ee)])])):(r(),i("div",{key:0,class:"upload-area small",onClick:n=>L(u),onDrop:w(n=>Y(n,u),["prevent"]),onDragover:t[3]||(t[3]=w(()=>{},["prevent"]))},[e("input",{ref_for:!0,ref:n=>T.value[u]=n,type:"file",accept:"image/*",style:{display:"none"},onChange:n=>Q(n,u)},null,40,Re),t[13]||(t[13]=e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[e("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),e("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),e("path",{d:"M21 15l-5-5L5 21"})],-1)),t[14]||(t[14]=e("span",null,"点击上传图片",-1))],40,Je))]),e("div",Ge,[e("div",He,[t[15]||(t[15]=e("label",null,"资产ID",-1)),D(e("input",{"onUpdate:modelValue":n=>l.asset_id=n,type:"text",placeholder:"如: A001",class:"form-input"},null,8,Pe),[[S,l.asset_id]])]),e("div",We,[t[16]||(t[16]=e("label",null,"资产名称",-1)),D(e("input",{"onUpdate:modelValue":n=>l.asset_name=n,type:"text",placeholder:"如: 车载控制系统",class:"form-input"},null,8,qe),[[S,l.asset_name]])]),e("div",Xe,[t[17]||(t[17]=e("label",null,"攻击树标题",-1)),D(e("input",{"onUpdate:modelValue":n=>l.title=n,type:"text",placeholder:"如: 针对XX的攻击树分析",class:"form-input"},null,8,Ke),[[S,l.title]])]),e("div",Qe,[t[18]||(t[18]=e("label",null,"描述",-1)),D(e("textarea",{"onUpdate:modelValue":n=>l.description=n,placeholder:"请输入攻击树描述...",class:"form-textarea",rows:"2"},null,8,Ye),[[S,l.description]])])])])]))),128)),e("button",{class:"btn btn-add-tree",onClick:X},[...t[19]||(t[19]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[e("circle",{cx:"12",cy:"12",r:"10"}),e("line",{x1:"12",y1:"8",x2:"12",y2:"16"}),e("line",{x1:"8",y1:"12",x2:"16",y2:"12"})],-1),b(" 添加攻击树 ",-1)])])])]),e("div",Ze,[e("button",{class:"btn btn-primary generate-btn",disabled:!d.value||f.value,onClick:ee},[f.value?(r(),i("svg",st,[...t[22]||(t[22]=[e("circle",{cx:"12",cy:"12",r:"10","stroke-opacity":"0.25"},null,-1),e("path",{d:"M12 2a10 10 0 0110 10","stroke-linecap":"round"},null,-1)])])):(r(),i("svg",tt,[...t[21]||(t[21]=[e("path",{d:"M12 3l1.912 5.813a2 2 0 001.275 1.275L21 12l-5.813 1.912a2 2 0 00-1.275 1.275L12 21l-1.912-5.813a2 2 0 00-1.275-1.275L3 12l5.813-1.912a2 2 0 001.275-1.275L12 3z"},null,-1)])])),b(" "+y(f.value?"正在生成...":"一键生成TARA报告"),1)],8,et)])])]),M.value?(r(),i("div",{key:0,class:"modal-overlay",onClick:se},[e("div",{class:"modal-content success-modal",onClick:t[4]||(t[4]=w(()=>{},["stop"]))},[t[29]||(t[29]=F('<div class="success-icon" data-v-df85f461><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-df85f461><circle cx="12" cy="12" r="10" data-v-df85f461></circle><path d="m9 12 2 2 4-4" data-v-df85f461></path></svg></div><h3 data-v-df85f461>报告生成成功！</h3><p class="success-message" data-v-df85f461>您的TARA报告已成功生成，可以前往报告中心查看和下载。</p>',3)),(k=c.value)!=null&&k.statistics?(r(),i("div",lt,[e("div",at,[e("span",ot,y(c.value.statistics.assets_count||0),1),t[23]||(t[23]=e("span",{class:"stat-label"},"资产数量",-1))]),e("div",nt,[e("span",it,y(c.value.statistics.threats_count||0),1),t[24]||(t[24]=e("span",{class:"stat-label"},"威胁场景",-1))]),e("div",rt,[e("span",dt,y(c.value.statistics.high_risk_count||0),1),t[25]||(t[25]=e("span",{class:"stat-label"},"高风险项",-1))])])):I("",!0),e("div",ut,[N(o,{to:"/reports",class:"btn btn-primary"},{default:ne(()=>[...t[26]||(t[26]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[e("path",{d:"M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"}),e("polyline",{points:"9 22 9 12 15 12 15 22"})],-1),b(" 前往报告中心 ",-1)])]),_:1}),e("a",{href:p.value,class:"btn btn-secondary",download:""},[...t[27]||(t[27]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[e("path",{d:"M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"}),e("polyline",{points:"7,10 12,15 17,10"}),e("line",{x1:"12",y1:"15",x2:"12",y2:"3"})],-1),b(" 立即下载 ",-1)])],8,ct),e("button",{class:"btn btn-ghost",onClick:le},[...t[28]||(t[28]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[e("path",{d:"M12 3l1.912 5.813a2 2 0 001.275 1.275L21 12l-5.813 1.912a2 2 0 00-1.275 1.275L12 21l-1.912-5.813a2 2 0 00-1.275-1.275L3 12l5.813-1.912a2 2 0 001.275-1.275L12 3z"})],-1),b(" 继续生成 ",-1)])])])])])):I("",!0),h.value.show?(r(),i("div",{key:1,class:"modal-overlay",onClick:j},[e("div",{class:"modal-content image-modal",onClick:t[5]||(t[5]=w(()=>{},["stop"]))},[e("div",vt,[e("h3",null,y(h.value.title),1),e("button",{class:"btn-close",onClick:j},[...t[30]||(t[30]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])])]),e("div",pt,[e("img",{src:h.value.url,alt:h.value.title},null,8,ft)])])])):I("",!0)])}}},kt=z(mt,[["__scopeId","data-v-df85f461"]]);export{kt as default};
